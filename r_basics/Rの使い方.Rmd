---
title: "R入門"
subtitle: "<small>A tutorial for R</small>"
author: "阿部景太"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [default,ninjutsu,useR-fonts]
    nature:
      highlightStyle: github
      highlightLines: true
      coutIncrementalSlides: false
      ratio: 16:9
      
---

<style type="text/css">
.remark-slide-content {
    font-size: 30px;
    font-family: "メイリオ" ;
    padding: 1em 4em 1em 4em;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
pacman::p_load(
  tidyverse,
  knitr,
  kableExtra,
  patchwork,
  cols4all
)

options(scipen=999)
```



# R?

- 　**R** は統計、データ分析、作図のためのインタープリタープログラミング言語

- 統計やデータ分析を行うアプリ
  - 他にはSPSS, Stata
  - Pythonもよく使われる

---

# Rのよいところ

- 無料
- 多くにプラットフォーム（MacOS, Windows, Linux)で使用可能
- たくさんの資料がネット上に存在する
- 分析結果をプレゼンテーションするツールが充実している
 - Rstudio: 統合開発環境(IDE)
 - Shiny: 相互的な作図などができるアプリ [例](https://keita43a.shinyapps.io/easter_island/)
- 豊富なパッケージ
  - 多くのエンジニアや研究者が公開

---

# Rの欠点

- Rは進化が早い
- 遅い
  - 一般的なデータ分析をするのには問題がない
  - ビッグデータや複雑な統計モデルを走らせると、遅かったりメモリ消費が激しい
- CUIなので、最初の学習が難しい
  
---

# CUIとGUI

- CUI: Character User Interface
  - 命令を文字で行う（キーボードを使う）操作環境

- GUI: Graphic User Interface
  - マウスでクリックしながら使う操作環境

---

# GUIの方が楽？

- GUIの方が楽では？
  - マウスで操作ができる方がよさそう？

--

- CUIは記録ができる
  - 何度も同じ操作を覚えている
  - 人が書いた一連の操作（コード）をコピー・参考にできる
  - 柔軟性が高い

---

# 統合開発環境 IDE

- IDE: Integrated Development Environment
  - ソフトウェア開発や、データ分析のプロセスをワンストップで行える環境
 - 一部GUIを導入したり、CUIによる操作をアシストする
- 特に強い好みがない限り、**Rstudio**をおすすめ

---

# RとRstudioのインストール

- 学校のパソコンにはすでにインストールされている
- 自分のパソコンに導入したい人は[このスライド](https://speakerdeck.com/s_uryu/introduction-to-r)か[ここ](https://yukiyanai.github.io/jp/resources/)にある「RとRStudioのインストール方法の解説」を参照

---

# コンピュータのディレクトリ構造

```{r  label = directory, echo = FALSE, fig.cap = "ディレクトリ構造", out.width = '90%'}
knitr::include_graphics("fig/directory_structure.png")
```

---

## path: コンピュータ上の住所

`j:`というドライブの下の`abezemi`というフォルダの下にある`r_renshu`というフォルダにある`kadai1.R`というファイルがあるとする。

そのファイルのpathは`j:/abezemi/r_renshu/kadai1.R`となる。

コンピュータ上では、このように文字でファイルの場所と名前を指定することがよくある。

---

# ゼミフォルダ

ゼミフォルダを作る

- 自分の学生番号のドライブ(例 s1234567)の下に abezemi フォルダを作成
- ドライブ上で右クリック→新規作成→フォルダ

---

# 作業スペース

コンピューター上では、どこかのディレクトリ（フォルダ）が作業場所になっている。
今の作業場所は`getwd()`で表示できる。

```{r, eval=FALSE}
getwd()
```

これを変更するには`setwd(path)`で変更できる。

```{r,eval=FALSE}
setwd("j:/abezemi/r_renshu")
```

ここでは`j:`ドライブの下の`abezemi`フォルダの下の`r_renshu`フォルダに設定。
もう一度`getwd()`して変更されたか確認しよう。

---

# プロジェクトの作成

作業場所を指定しても、ファイルの管理が面倒だったりする。

RStudioのRプロジェクトという機能を使うと、以下のメリットがある

- データやスクリプト（コード）へのアクセスが容易
- Git によるバージョン管理のベースにもなる
- 異なる環境でも同じ作業スペースが設定される

---

# Rプロジェクトの作成

- File -> "New Project"
  -もしくは右上の "Project (none)"

- New Directoryでプロジェクトを作成

- "New Project"を選択

- プロジェクト名を入力: r_renshu 
 - 英語で。日本語は使えない（もしくはトラブルの元になる）

---

# スクリプトの作成

Rとの"対話"は、Rstudioの左下の区画(Console)で行われる。
そのままConsoleに入力しても機能するが、**スクリプト**(コード)に書くことで、記録を残しながらRに命令を与えることができる。

**作成**
- File -> New File -> R script
- もしくは左上の区画の白い資格に緑の＋マークのところから、R Script



---

# スクリプトの保存

Rスクリプトは.Rで終わるファイルとして保存される (例：kadai1.R)

**保存**
- File -> Save -> 名前をつける
- もしくはフロッピーのアイコン


---

# 実行してみる

R scriptに以下のように書く

```{r}
print("Hello World!")
```

カーソルが同じ行にあることを確認して、Runをクリック
もしくは、Ctrlを押しながらEnter

"Hello World!"と表示されれば成功。

---

# スクリプトの書く際の注意点

R script上では\#から始まる行は、コメントとして認識され、実行するとコンソールには表示されるが、何も起こらない。メモなどを書く際に使う。

```{r}
# これは初めてのRのコードです。
print("Hello World")
```

もしくは一度使ったが、今は実行したくないコードを一時的に向こうにする（コメントアウト）

```{r}
# print("Good Evening")
```


---

# 計算機としてのR

```{r, echo =TRUE}
# 足し算
1 + 1
```

```{r, echo =TRUE}
#掛け算は * 
2 * 3
```

---

# 計算機としてのR

```{r, echo =TRUE}
# 割り算は /
(2+7)/3
```

```{r, echo =TRUE}
# 割り切れない場合はある程度まで桁が表示
10/3
```

---

# 論理演算

書いてあることが真か偽か？

```{r}
# 「10は5より大きい」という命題は正しい？
10 > 5
```

```{r}
# 「等しい」は=が2つ == 
"musashi" == "musashi"
```

```{r}
"musashi" == "634"
```


---

# 変数へのオブジェクトの代入

```{r}
# x や yという「入れ物」に数字を代入
x <- 8
y <- 3

z <- x + y
z
```

---

# データ型

Rのオブジェクトにはいくつかの「型」がある

```{r}
# 実数
x <- 8
mode(x)
```

```{r}
# 文字列
y <- "musashi"
mode(y)
```

---

# データ型：注意点

数字であっても文字列として扱われていると、計算ができない

```{r}
# 数字だが文字列
z <- "5"
mode(z)
```

```{r, error = TRUE}
z + 6
```

---

# データ型の変換

```{r}
# データ型のチェック
mode(z)
# 実数かどうか？
is.numeric(z)
```

```{r}
# データ型を実数に変換して再度zに代入
z <- as.numeric(z)
# 再度チェック
is.numeric(z)
```

---

# ベクトル

順序のある要素の集まりをベクトルと呼ぶ。
`c()`関数で作成することができる。

```{r}
v1 <- c(1,2,3,4,5)
v1
```

ベクトルは、文字や論理値など取ることができる。

```{r}
v2 <- c("musashi","nerima","ekoda")
v2
```

```{r}
v3 <- c(FALSE,TRUE,TRUE,FALSE)
v3
```


---

# ベクトルの型

異なるデータ型を同じベクトルに混ぜることはできない。
混ぜると、一定のルールに基づいてある型が他の型より優先される


```{r}
# 数値と論理値を混ぜると、数値になる。(FALSE->0, TRUE->1)
v4 <- c(FALSE,1,TRUE)
v4 
```

```{r}
# 数値と論理値と文字列を混ぜると、全部文字列になる

v5 <- c(FALSE,1,"musashi")
v5
```

---

# ベクトル：連続した数値

連続した数値を入力したい場合はコロン`:`を使う

```{r}
v6 <- c(1:10)
v6
```

nずつ増える数列を作りたい場合は、`seq()`関数を使う

```{r}
# 例：2から50まで２ずつ増える数列
v7 <- seq(2,50,by=2)
```

**練習問題**：3から60まで3ずつ増える数列ベクトルを作りなさい

---

# ベクトル：連続した数値

同じ数値がたくさんあるベクトルを作りたい場合は`rep()`関数を使う

```{r}
# 5が100個ならぶベクトル
v8 <- rep(5,100)
v8
```

本当に100個出てるか？
ベクトルの要素の数を数える関数は`length`

```{r}
length(v8)
```

---

# 参照

ベクトルのn個目の要素を参照したいときは角カッコを使う`[]`

```{r}
# v7の3つ目の要素は6
v7[3]
```

```{r}
# v7の2,3,5つ目の要素
v7[c(2,3,5)]
```

---

# リスト

様々なベクトルやデータなどのオブジェクトをひとまとめにして扱うことができるのがリスト

リストは`list()`関数で作成する

```{r}
# aというオブジェクトに、文字列ベクトル、数値ベクトル、データが混ざって入っている。
# カンマ, の後に改行しているが、listのかっこが閉じるまではひとまとまりだと扱われる。

a <- list(
  c("a", "b", NA, "d"),
  num = c(3, 1.1, 5),
  data = head(mtcars, 1))

a
```

---

# リストの参照

リストの参照も角カッコでできる
```{r}
# リストの参照
a[1]
a[2]
```

---

# リストの参照

リストの中身のみを取り出したい場合は、二重括角カッコを使う`[[]]`

```{r}
a[[3]]
```

---

# データフレーム

Rではデータをデータフレームという形で扱う
例として、Rに入っているmtcarsというデータを見てみよう

```{r}
# mtvarsというデータをdata1というオブジェクト(入れ物)に入れる
data1 <- mtcars
```



---

# データを見てみる

右上のEnvironment区画にdata1というオブジェクトが生成される
クリックしてみると、エクセルのような画面が現れる

また`View()`という関数をつかっても、同じようにデータを見ることができる。

```{r eval=FALSE}
# data1を見るビューワーがRstudio上で開く
View(data1)
```

---

# データを見てみる

また、データの最初だけみたいときは、`head()`, また後ろだけ見たいときは`tail()`関数を使う。
デフォルトでは、6行だけ表示されるが、行数は引数nで調整できる。

```{r}
# data1の最初の10行がコンソールに表示される
head(data1, n=10)
```

---

# データの「大きさ」

データの行数や列数を調べる。

```{r}
dim(mtcars)
```

32行、11列

---

# 列の名前一覧

```{r}
names(mtcars)
```

---

# mtcarsの変数


[, 1]	mpg	Miles/(US) gallon  
[, 2]	cyl	Number of cylinders  
[, 3]	disp	Displacement (cu.in.)  
[, 4]	hp	Gross horsepower  
[, 5]	drat	Rear axle ratio  
[, 6]	wt	Weight (1000 lbs)  
[, 7]	qsec	1/4 mile time  
[, 8]	vs	Engine (0 = V-shaped, 1 = straight)  
[, 9]	am	Transmission (0 = automatic, 1 = manual)  
[,10]	gear	Number of forward gears  
[,11]	carb	Number of carburetors  

---

# 変数の要約

```{r}
summary(mtcars)
```

---

# 変数の要約

| Min. | nth Qu. | Median | Mean | Max. |
|------|---------|--------|------|------|
| 最小 |  n分位  | 中央値 | 平均 | 最大 |


---

# 変数の取り出し

データから変数を一つ取り出す
```{r}
# データフレーム$変数 で変数の列をベクトルとして取り出す
 data1$mpg
```

---

# 変数の取り出しと計算

```{r}
# 平均 mean()関数
mean(data1$mpg)

# 中央値 median()関数
median(data1$mpg)

# 分散 var()関数
var(data1$mpg)
```

---

# 変数の取り出しと計算

```{r}
# 合計 sum()関数
sum(data1$mpg)
```


---

# Vizualization (図示): hist()関数

データを理解するためには図示が効果的。  
データの分布(散らばり方)を理解するのに

```{r, fig.height=4,fig.align='center'}
# ヒストグラム hist()関数
hist(data1$mpg)
```

---

# hist()の設定

```{r, fig.height=4, fig.align='center'}
hist(data1$mpg,
     col = "steelblue",         # ヒストグラムの色
     main = "Histogram of mpg", # タイトル
     xlab = "Mile per gallon",  # X軸のラベル
     ylab = "Frequency",        # Y軸のラベル
     breaks = 10                # 区切りの数
     )
```

---

# boxplot()関数

```{r,fig.height=4, fig.align='center'}
boxplot(mtcars$mpg,
        main='Distribution of mpg values',
        ylab='mpg',
        col='steelblue',
        border='black')
```


---

# 2つの変数の関係

```{r,fig.height=4, fig.align='center'}
plot(mtcars$mpg, mtcars$wt,
     col='blue',            # 色
     main='mpg and weight',   # タイトル
     xlab='mpg',           # X軸のラベル
     ylab='wt',            # Y軸のラベル
     pch=19)               # 点の形
```

---

# パッケージについて

Rはデフォルト(初期状態)でインストールされている関数がたくさんある。

平均を`mean()`や、散布図を描く`plot()`などは関数であり、もともとRをインストールした時点で入っている。

--

しかし、さらにRを拡張して機能を強化することができる。  
それが**パッケージ**のインストールである。

たとえばスマホにはもともとアプリが入っているが、さらにいろんなアプリをダウンロードしてインストールできることに似ている。

---

# パッケージのインストール

パッケージのインストールをする方法は二つある。

1. `install.packages()`関数を使う方法

```{r, eval=FALSE}
install.packages("ggplot2")
```

2. Rstudioの右下の区画の[Packages]タブから、[Install]ボタンを押して、ダイアログに従ってインストール

---

# よく使うパッケージのインストール

`tidyverse`と呼ばれるパッケージをインストールしてみよう。
```{r, eval=FALSE}
install.packages("tidyverse")
```

実はこのパッケージはパッケージ**群**であり、複数のパッケージがインストールされる。

---

# Tidyverseについて

Tidyverseというパッケージ群は`ggplot2`, `dplyr`, `tidyr`, `readr`, `purrr`, `tibble`, `stringr`, `forcats`, `lubridate`という複数のパッケージを含む

たとえば`ggplot2`は図を描くためのパッケージであり、`plot()`関数などとかぶる。実際に、`ggplot2`では`plot()`と同じような図を出力することができる。Tidyverseシリーズは、データをより直感的に扱うための哲学に基づいて開発されており、Rオリジナルの関数ではないが、多くの人が使うパッケージ群となっておりRを学ぶならばほぼ必須といえる状態になりつつある。

---

# パッケージの読み込み

パッケージを読み込まないと、パッケージに入っている関数は使えない

```{r}
library(tidyverse)
```


---

# データの読み込み

今度はデータをファイルから読み込む。

ファイルの形式は、CSV形式（`.csv`), エクセル形式(`.xlsx`,`.xls`), Stataデータ形式(`.dta`)など色々ある。

ここではCSV形式について説明するが、その他のその他のファイル形式については[私達のRの第8章](https://www.jaysong.net/RBook/io.html#sec-io-read)を参照してほしい


---

# データの読み込み

`read_csv()`関数を使う。この関数は`readr`パッケージ含まれており、tidyverseパッケージ群の一つである。

```{r, echo =FALSE}
data2 <- gapminder::gapminder
## write_csv(data2,"../data/gapminder.csv")
```

```{r,eval=FALSE}
data2 <- read_csv("data/gapminder.csv")
```

---

# データの要約

```{r}
# 変数の一覧
names(data2)
```

---

# データの要約

```{r}
summary(data2)
```
---

# ggplot2

ggplot2とは、グラフィックの文法 (**g**rammar of **g**raphics)という概念に基づいて作図するパッケージ

それぞれのグラフの要素をlayer (層) として捉えて、重ねていくイメージ

---

# ggplot2 による作図 1

まず、作図に使うデータを指定し、キャンバスを作成する

```{r,fig.height=4,fig.align='center'}
ggplot(data=data2)
```


---

# ggplot2 による作図 2 : 本体作図

次に、グラフ本体を作図する。

```{r,fig.height=4,fig.align='center'}
ggplot(data=data2) + 
  # `geom_point()`関数で、散布図を作成
  geom_point(aes(x=gdpPercap,y=lifeExp,col=continent),size=0.5)
```
---

# ggplot2 による作図 3 : ラベル

```{r,fig.height=4,fig.align='center'}
ggplot(data=data2) + 
  geom_point(aes(x=gdpPercap,y=lifeExp,col=continent),size=0.5) +
    # `lab()`関数で、ラベルを設定
  labs(x = "一人あたりGDP", y = "平均余命", color = "大陸") +
  theme_bw(base_family="HiraKakuPro-W3") # Mac使っていると、これがないと文字化けする
```

---

# ggplot2による図の保存

```{r}
# ggplotの図をオブジェクトに代入

plot1 <- ggplot(data=data2) + 
  geom_point(aes(x=gdpPercap,y=lifeExp,col=continent),size=0.5) +
  labs(x = "一人あたりGDP", y = "平均余命", color = "大陸") +
  theme_bw(base_family="HiraKakuPro-W3")

# ggsave()関数を使って、図を保存
ggsave(file="figure/life_expectany.png",plot=plot1,device="png")

```

---

# 課題

- [私たちのR](https://www.jaysong.net/RBook/visualization1.html)の18章の18.1と18.2を読む
 - 必要に応じてそれよりも前の章も読む
 
- 説明にしたがって、図18.11を再現する
 - コードのコピペは禁止（意味がない）

- Rコードと保存した図(.png形式)をGoogle Classroomで提出
 - 2023年5月29日(月)締切
 
---

# 課題のレビュー
 
---

### よくあるエラー

`Error in read_csv("data/Countries.csv") :
could not find function "read_csv"`

`XXX`という関数が見つかりません、というエラー

**考えられるケース**

- `library()`で必要なパッケージを読み込めてない
- 関数のつづりが間違っている

---

### よくあるエラー2


Error: 'data/Countris.csv' does not exist in current working directory

XXX.csvというファイルが作業場所にありません。

**考えられるケース**
- そもそもファイルがない
- ファイルの指定場所が間違っている
- つづりが間違っている

---

# 課題２

- [政府統計の総合窓口e-stat](https://www.e-stat.go.jp/)へアクセス
- 「分野」-> 「農林水産業」-> 「漁業センサス」-> 「データベース」
- データを一つ選ぶ-> 「DB」
- ダウンロード
  - CSV形式(クロス集計表形式・UTF-8(BOM無し))
  - すべて「出力しない」
  
---

### 課題２

```{r, fig.height=4, fig.align='center'}
dataves2 <- read_csv("data/FEH_00500210_230529214946.csv")
ggplot(data=dataves2) + 
  geom_bar(aes(x=`(J117-30-2-001)経営体階層`,y=`漁業経営体数【経営体】`),stat="identity") + 
  theme_bw(base_family = "HiraKakuPro-W3")
```

---

### 課題２

```{r, fig.height=4, fig.align='center'}
dataves3 <- dataves2 %>% slice(2:17)
ggplot(data=dataves3) + 
  geom_bar(aes(x=`(J117-30-2-001)経営体階層`,y=`漁業経営体数【経営体】`),stat="identity") + 
  theme_bw(base_family = "HiraKakuPro-W3") +
  theme(axis.text.x = element_text(angle=45,hjust=1))
```

---

### 課題２

```{r, fig.height=7, fig.align='center',echo=FALSE}
dataves3 <- dataves2 %>% slice(2:17) %>% 
  mutate(ves_size = str_remove(`(J117-30-2-001)経営体階層`,"漁船使用_動力漁船使用_"),
         ves_size = str_remove(ves_size,"漁船使用_"))

ves_order <- dataves3$ves_size

dataves3 <- dataves3 %>% mutate(ves_size = factor(ves_size,levels=ves_order))

ggplot(data=dataves3) + 
  geom_bar(aes(x=ves_size,y=`漁業経営体数【経営体】`),stat="identity",fill="blue") + 
  labs(x="漁船のサイズ別経営体層",y="経営体数") +
  theme_bw(base_family = "HiraKakuPro-W3") +
  theme(axis.text.x = element_text(angle=45,hjust=1))
```

---

### 課題２

- 漁業センサスの中から自分の描きたいデータを選ぶ
  - 一人１データ、かぶりなし
  - 早いもの勝ち。Google Classroomに書き込む。
  - 締切：６月５日(月) 23:59
- データを適した形で描く
  - 第１締切：６月12日(月)23:59
  - 最終締切：６月19日(月)23:59

---

### 適した形？

```{r pressure, echo=FALSE, fig.cap="A caption", fig.align='center',out.width = '50%'}
knitr::include_graphics("figure/IMG_3452.jpg")
```

---

## 適した形？

- 棒グラフ：データの大きさを比較する
- 折れ線グラフ：時系列での変化をみる
- 円グラフ：全体に占める割合をみる
- 積み上げ棒グラフ：累積データから内訳を比較する
- 散布図：2つのデータの相関関係をみる

例：[グラフの種類と使い分け、間違った使い方](https://www.tableau.com/ja-jp/learn/articles/graph-type)(Tableau)
